<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Kraken Z63 Custom Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  height: 100%; overflow: hidden;
  font-family: 'Segoe UI', system-ui, sans-serif;
  user-select: none;
  background: #000;
  image-rendering: pixelated;
  -webkit-font-smoothing: antialiased;
}

#bg-container {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #1a1a1a;
}
#bg-layer {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background-size: cover; background-position: center;
  cursor: grab;
}
#bg-layer:active { cursor: grabbing; }
#bg-layer.grayscale { filter: grayscale(100%) saturate(0%) brightness(var(--grayscale-brightness, 1)) contrast(var(--grayscale-contrast, 1)); }

#kraken-preview {
  position: fixed; top: 10px; right: 10px; width: 320px; height: 320px;
  border-radius: 50%; overflow: hidden; background: #1a1a1a;
  z-index: 12; border: 2px solid #333; display: none;
}
#kraken-preview.active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
#kraken-preview .bg-layer {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background-size: cover; background-position: center;
}
#kraken-preview .content-layer {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  opacity: 0; transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  transform: scale(min(var(--global-scale, 1), 1));
}
#kraken-preview .content-layer.active { opacity: 1; z-index: 2; }
#kraken-preview #clock-content-preview {
  text-align: center; color: #fff; gap: var(--hours-spacing, 0px);
  transform: translateY(var(--clock-y, 0%)) scale(min(var(--global-scale, 1), 1));
}
#kraken-preview #hours-preview {
  font-size: var(--hours-size, 140px); font-weight: var(--hours-weight, 900);
  -webkit-text-stroke: var(--text-stroke, 0.5px) black;
}
#kraken-preview #minutes-preview {
  font-size: var(--minutes-size, 100px); font-weight: var(--minutes-weight, 700);
  margin-top: var(--hours-spacing, 0px); -webkit-text-stroke: var(--text-stroke, 0.5px) black;
}
#kraken-preview #monitoring-content-preview {
  display: flex !important; flex-direction: row !important; justify-content: center; align-items: center;
  gap: var(--temp-spacing, 80px); text-align: center; color: #fff; width: 100%;
  transform: translateY(var(--monitoring-y, 0%)) scale(min(var(--global-scale, 1), 1));
}
#kraken-preview .temp-item { display: flex !important; flex-direction: column; align-items: center; gap: var(--temp-gap, 8px); flex: 1; }
#kraken-preview .temp-label { font-size: var(--label-size, 18px); font-weight: var(--label-weight, 600); opacity: var(--label-opacity, 0.8); -webkit-text-stroke: var(--text-stroke, 0.5px) black; }
#kraken-preview .temp-value { font-size: var(--temp-size, 80px); font-weight: var(--temp-weight, 900); text-shadow: 0 0 var(--glow-intensity, 10px) currentColor; -webkit-text-stroke: var(--text-stroke, 0.5px) black; }

#file-input { display: none; }

.content-layer {
  position: absolute; top: 0; left: 0; width: 320px; height: 320px;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  opacity: 0; transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  pointer-events: none; transform: scale(var(--global-scale, 1));
  left: 50%; top: 50%; transform-origin: center; transform: translate(-50%, -50%) scale(var(--global-scale, 1));
}
.content-layer.active { opacity: 1; z-index: 3; pointer-events: auto; }
#clock-content {
  text-align: center; color: #fff; gap: var(--hours-spacing, 0px);
  transform: translate(-50%, calc(-50% + var(--clock-y, 0%))) scale(var(--global-scale, 1));
  cursor: move;
}
#hours { font-size: var(--hours-size, 140px); font-weight: var(--hours-weight, 900); -webkit-text-stroke: var(--text-stroke, 0.5px) black; }
#minutes { font-size: var(--minutes-size, 100px); font-weight: var(--minutes-weight, 700); margin-top: var(--hours-spacing, 0px); -webkit-text-stroke: var(--text-stroke, 0.5px) black; }
#monitoring-content {
  display: flex !important; flex-direction: row !important; justify-content: center; align-items: center;
  gap: var(--temp-spacing, 80px); text-align: center; color: #fff; width: 100%;
  transform: translate(-50%, calc(-50% + var(--monitoring-y, 0%))) scale(var(--global-scale, 1));
  cursor: move;
}
.temp-item { display: flex !important; flex-direction: column; align-items: center; gap: var(--temp-gap, 8px); flex: 1; }
.temp-label { font-size: var(--label-size, 18px); font-weight: var(--label-weight, 600); opacity: var(--label-opacity, 0.8); -webkit-text-stroke: var(--text-stroke, 0.5px) black; }
.temp-value { font-size: var(--temp-size, 80px); font-weight: var(--temp-weight, 900); text-shadow: 0 0 var(--glow-intensity, 10px) currentColor; -webkit-text-stroke: var(--text-stroke, 0.5px) black; }

body.negative .content-layer, body.gradient .content-layer {
  mix-blend-mode: difference;
  filter: brightness(var(--brightness, 1.2)) contrast(var(--contrast, 1.3)) saturate(var(--saturation, 1.2));
}
body.grayscale .content-layer {
  color: white !important; text-shadow: 0 0 var(--glow-intensity, 10px) rgba(255,255,255,0.9);
  filter: brightness(var(--brightness, 1.2)) contrast(var(--contrast, 1.3)) saturate(var(--saturation, 1.2));
}
body.gradient #hours, body.gradient #minutes, body.gradient .temp-value, body.gradient .temp-label {
  background: linear-gradient(var(--gradient-angle, 45deg), var(--primary-color, #ff6b6b), var(--secondary-color, #4ecdc4), var(--accent-color, #45b7d1), var(--primary-color, #ff6b6b));
  background-size: var(--gradient-size, 300%) 100%; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text; animation: gradient-flow var(--gradient-speed, 4s) linear infinite;
  filter: brightness(var(--gradient-brightness, 1.2));
}
@keyframes gradient-flow { 0% { background-position: 0% 50%; } 100% { background-position: 300% 50%; } }

#controls {
  position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); padding: 15px; border-radius: 15px; color: white;
  display: none; flex-wrap: wrap; gap: 10px; max-width: 95%; z-index: 10; font-size: 12px; max-height: 80vh; overflow-y: auto;
  border: 1px solid rgba(255,255,255,0.1);
}
.control-group { display: flex; flex-direction: column; gap: 3px; min-width: 120px; }
.control-group label { font-weight: 600; opacity: 0.9; font-size: 11px; }
.control-group input, .control-group select { background: rgba(255,255,255,0.1); border: none; border-radius: 5px; padding: 3px; color: white; font-size: 11px; }
input[type="range"] { height: 4px; }
input[type="range"]::-webkit-slider-thumb { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; }
input[type="color"] { width: 35px; height: 25px; padding: 0; }
input[type="button"] { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); border: none; padding: 5px 10px; border-radius: 5px; color: white; cursor: pointer; font-size: 10px; }
.file-upload { background: rgba(255,255,255,0.1); border: 2px dashed rgba(255,255,255,0.3); padding: 6px; border-radius: 5px; text-align: center; cursor: pointer; font-size: 10px; }
.file-upload:hover { border-color: #4ecdc4; background: rgba(78,205,196,0.1); }

.image-viewer { display: flex; align-items: center; gap: 5px; max-width: 100%; }
.image-viewer img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); }
.image-viewer button, .image-viewer select { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); border: none; border-radius: 5px; padding: 5px; color: white; cursor: pointer; font-size: 12px; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; }
.image-viewer select { width: auto; padding: 2px; height: 25px; }
.image-viewer button:disabled, .image-viewer select:disabled { opacity: 0.3; cursor: not-allowed; }
.image-viewer .delete-button { background: #ff6b6b; border-radius: 50%; width: 20px; height: 20px; line-height: 20px; text-align: center; font-size: 12px; }

#bg-duration-value { font-size: 10px; opacity: 0.8; text-align: center; }

#toggle-panel {
  position: fixed; top: 10px; right: calc(320px + 20px); background: linear-gradient(45deg, rgba(0,0,0,0.9), rgba(78,205,196,0.2));
  color: white; border: none; padding: 12px 18px; border-radius: 25px; cursor: pointer; font-size: 14px; z-index: 14;
  min-width: 50px; min-height: 50px; display: block; opacity: 1; transition: all 0.3s;
}
#toggle-panel:hover { opacity: 1; transform: scale(1.05); }

/* Media query pour Kraken Z63 (320x320) */
@media (max-height: 320px), (max-width: 320px) {
  #kraken-preview { display: none !important; }
  #toggle-panel { display: none !important; }
  #controls { display: none !important; }
  #bg-container, #bg-layer { width: 320px; height: 320px; left: 50%; top: 50%; transform: translate(-50%, -50%); }
  #hours, #hours-preview { font-size: min(var(--hours-size, 140px), 200px) !important; }
  #minutes, #minutes-preview { font-size: min(var(--minutes-size, 100px), 150px) !important; }
  .temp-value { font-size: min(var(--temp-size, 80px), 100px) !important; }
  .temp-label { font-size: min(var(--label-size, 18px), 24px) !important; }
  #monitoring-content, #monitoring-content-preview { gap: min(var(--temp-spacing, 80px), 40px) !important; }
}
</style>
</head>
<body class="negative">
<input type="file" id="file-input" accept="image/*">
<div id="bg-container">
  <div id="bg-layer"></div>
</div>
<div id="kraken-preview" class="active">
  <div class="bg-layer"></div>
  <div id="clock-content-preview" class="content-layer active">
    <div id="hours-preview">--</div>
    <div id="minutes-preview">--</div>
  </div>
  <div id="monitoring-content-preview" class="content-layer">
    <div class="temp-item"><div class="temp-label">CPU</div><div class="temp-value" id="cpu-temp-preview">--°</div></div>
    <div class="temp-item"><div class="temp-label">GPU</div><div class="temp-value" id="gpu-temp-preview">--°</div></div>
  </div>
</div>
<div id="clock-content" class="content-layer active">
  <div id="hours">--</div>
  <div id="minutes">--</div>
</div>
<div id="monitoring-content" class="content-layer">
  <div class="temp-item"><div class="temp-label">CPU</div><div class="temp-value" id="cpu-temp">--°</div></div>
  <div class="temp-item"><div class="temp-label">GPU</div><div class="temp-value" id="gpu-temp">--°</div></div>
</div>
<div id="controls">
  <div class="control-group"><label>Taille Heures</label><input type="range" id="hours-size" min="5" max="200" value="140"></div>
  <div class="control-group"><label>Taille Minutes</label><input type="range" id="minutes-size" min="5" max="150" value="100"></div>
  <div class="control-group"><label>Gras Heures</label><input type="range" id="hours-weight" min="100" max="900" value="900"></div>
  <div class="control-group"><label>Gras Minutes</label><input type="range" id="minutes-weight" min="100" max="900" value="700"></div>
  <div class="control-group"><label>Espacement H-M</label><input type="range" id="hours-spacing" min="-100" max="100" value="0"></div>
  <div class="control-group"><label>Taille Températures</label><input type="range" id="temp-size" min="5" max="100" value="80"></div>
  <div class="control-group"><label>Taille Labels</label><input type="range" id="label-size" min="5" max="24" value="18"></div>
  <div class="control-group"><label>Gras Températures</label><input type="range" id="temp-weight" min="100" max="900" value="900"></div>
  <div class="control-group"><label>Espacement CPU-GPU</label><input type="range" id="temp-spacing" min="-200" max="200" value="80"></div>
  <div class="control-group"><label>Espacement Temp</label><input type="range" id="temp-gap" min="-50" max="50" value="8"></div>
  <div class="control-group"><label>Opacité Labels</label><input type="range" id="label-opacity" min="0" max="1" step="0.05" value="0.8"></div>
  <div class="control-group"><label>Glow Intensité</label><input type="range" id="glow-intensity" min="0" max="20" value="10"></div>
  <div class="control-group"><label>Contour Texte (px)</label><input type="range" id="text-stroke" min="0" max="2" step="0.1" value="0.5"></div>
  <div class="control-group"><label>Pos Y Horloge (%)</label><input type="range" id="clock-y" min="-50" max="50" value="0" step="1"></div>
  <div class="control-group"><label>Pos Y Monitoring (%)</label><input type="range" id="monitoring-y" min="-50" max="50" value="0" step="1"></div>
  <div class="control-group"><label>Échelle Globale (%)</label><input type="range" id="global-scale" min="50" max="300" value="100" step="5"></div>
  <div class="control-group"><label>Espacement Global (%)</label><input type="range" id="global-spacing" min="50" max="200" value="100" step="5"></div>
  <div class="control-group"><label>↻ Reset Positions</label><input type="button" id="reset-positions" value="Centrer"></div>
  <div class="control-group"><label>📁 Ajouter image</label><div class="file-upload" id="file-upload">Ajouter image</div></div>
  <div class="control-group"><label>Durée Image (s)</label><input type="range" id="bg-duration" min="5" max="60" step="1" value="10"><span id="bg-duration-value">10 s</span></div>
  <div class="control-group"><label>Image Actuelle</label><div class="image-viewer" id="image-viewer"><button id="prev-image">&lt;</button><img id="current-image" src="" alt="Image actuelle"><button id="next-image">&gt;</button><button id="delete-image" class="delete-button">✕</button><select id="image-mode"><option value="negative">Négatif</option><option value="gradient">Gradient</option><option value="grayscale">Noir & Blanc</option></select></div></div>
  <div class="control-group"><label>Pos X Image (%)</label><input type="range" id="bg-x" min="0" max="100" value="50"></div>
  <div class="control-group"><label>Pos Y Image (%)</label><input type="range" id="bg-y" min="0" max="100" value="50"></div>
  <div class="control-group"><label>Taille Image (%)</label><input type="range" id="bg-size" min="25" max="300" value="100"></div>
  <div class="control-group"><label>URL Fond</label><input type="text" id="bg-url" placeholder="URL image"></div>
  <div class="control-group"><label>Luminosité</label><input type="range" id="brightness" min="0.5" max="3" step="0.1" value="1.2"></div>
  <div class="control-group"><label>Contraste</label><input type="range" id="contrast" min="0.5" max="3" step="0.1" value="1.3"></div>
  <div class="control-group"><label>Saturation</label><input type="range" id="saturation" min="0.5" max="2.5" step="0.1" value="1.2"></div>
  <div class="control-group"><label>Couleur Principale</label><input type="color" id="primary-color" value="#ff6b6b"></div>
  <div class="control-group"><label>Couleur Secondaire</label><input type="color" id="secondary-color" value="#4ecdc4"></div>
  <div class="control-group"><label>Couleur Accent</label><input type="color" id="accent-color" value="#45b7d1"></div>
  <div class="control-group"><label>Angle Gradient</label><input type="range" id="gradient-angle" min="0" max="360" value="45"></div>
  <div class="control-group"><label>Vitesse (s)</label><input type="range" id="gradient-speed" min="1" max="15" step="0.5" value="4"></div>
  <div class="control-group"><label>Taille Gradient</label><input type="range" id="gradient-size" min="200" max="800" value="300"></div>
  <div class="control-group"><label>Luminosité Gradient</label><input type="range" id="gradient-brightness" min="0.5" max="2" step="0.1" value="1.2"></div>
  <div class="control-group"><label>Lum N&B Fond</label><input type="range" id="grayscale-brightness" min="0.1" max="3" step="0.1" value="1"></div>
  <div class="control-group"><label>Contraste N&B</label><input type="range" id="grayscale-contrast" min="0.1" max="4" step="0.1" value="1.5"></div>
</div>
<button id="toggle-panel">⚙️</button>

<script>
const controls = {
  'hours-size': document.getElementById('hours-size'),
  'minutes-size': document.getElementById('minutes-size'),
  'hours-weight': document.getElementById('hours-weight'),
  'minutes-weight': document.getElementById('minutes-weight'),
  'hours-spacing': document.getElementById('hours-spacing'),
  'clock-y': document.getElementById('clock-y'),
  'temp-size': document.getElementById('temp-size'),
  'label-size': document.getElementById('label-size'),
  'temp-weight': document.getElementById('temp-weight'),
  'temp-spacing': document.getElementById('temp-spacing'),
  'temp-gap': document.getElementById('temp-gap'),
  'label-opacity': document.getElementById('label-opacity'),
  'glow-intensity': document.getElementById('glow-intensity'),
  'text-stroke': document.getElementById('text-stroke'),
  'monitoring-y': document.getElementById('monitoring-y'),
  'global-scale': document.getElementById('global-scale'),
  'global-spacing': document.getElementById('global-spacing'),
  'bg-url': document.getElementById('bg-url'),
  'bg-x': document.getElementById('bg-x'),
  'bg-y': document.getElementById('bg-y'),
  'bg-size': document.getElementById('bg-size'),
  'bg-duration': document.getElementById('bg-duration'),
  'brightness': document.getElementById('brightness'),
  'contrast': document.getElementById('contrast'),
  'saturation': document.getElementById('saturation'),
  'primary-color': document.getElementById('primary-color'),
  'secondary-color': document.getElementById('secondary-color'),
  'accent-color': document.getElementById('accent-color'),
  'gradient-angle': document.getElementById('gradient-angle'),
  'gradient-speed': document.getElementById('gradient-speed'),
  'gradient-size': document.getElementById('gradient-size'),
  'gradient-brightness': document.getElementById('gradient-brightness'),
  'grayscale-brightness': document.getElementById('grayscale-brightness'),
  'grayscale-contrast': document.getElementById('grayscale-contrast'),
  'image-mode': document.getElementById('image-mode')
};

const clockContent = document.getElementById('clock-content');
const monitoringContent = document.getElementById('monitoring-content');
const bgContainer = document.getElementById('bg-container');
const bgLayer = document.getElementById('bg-layer');
const krakenPreview = document.getElementById('kraken-preview');
const previewBgLayer = krakenPreview.querySelector('.bg-layer');
const clockContentPreview = document.getElementById('clock-content-preview');
const monitoringContentPreview = document.getElementById('monitoring-content-preview');
const controlsPanel = document.getElementById('controls');
const togglePanel = document.getElementById('toggle-panel');
const fileInput = document.getElementById('file-input');
const fileUpload = document.getElementById('file-upload');
const imageViewer = document.getElementById('image-viewer');
const currentImage = document.getElementById('current-image');
const prevImage = document.getElementById('prev-image');
const nextImage = document.getElementById('next-image');
const deleteImage = document.getElementById('delete-image');
const bgDurationValue = document.getElementById('bg-duration-value');

let images = [];
let currentImageIndex = 0;
let viewerImageIndex = 0;
let slideshowInterval = null;
const imageCache = new Map();

function preloadImage(url) {
  if (imageCache.has(url)) {
    console.log('Image from cache:', url);
    return Promise.resolve(true);
  }
  return new Promise(resolve => {
    const img = new Image();
    img.src = url;
    img.onload = () => {
      if (imageCache.size >= 3) {
        const oldestKey = imageCache.keys().next().value;
        imageCache.delete(oldestKey);
        console.log('Removed oldest image from cache:', oldestKey);
      }
      imageCache.set(url, true);
      console.log('Image preloaded:', url);
      resolve(true);
    };
    img.onerror = () => {
      console.error('Failed to preload image:', url);
      resolve(false);
    };
    setTimeout(() => {
      if (!imageCache.has(url)) {
        console.warn('Preload timeout for:', url);
        resolve(false);
      }
    }, 5000);
  });
}

async function preloadAllImages() {
  console.log('Preloading all images:', images.length);
  for (const img of images) {
    await preloadImage(img.url);
  }
  console.log('All images preloaded');
}

function loadImageFile(file) {
  if (!file.type.startsWith('image/')) {
    console.log('Non-image file skipped:', file.name);
    return Promise.resolve(null);
  }
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      console.log('Image loaded:', file.name);
      resolve(e.target.result);
    };
    reader.onerror = () => {
      console.error('Error reading file:', file.name);
      resolve(null);
    };
    reader.readAsDataURL(file);
  });
}

function addImage(file) {
  console.log('Adding image:', file.name);
  loadImageFile(file).then(url => {
    if (url) {
      const bgSize = parseFloat(controls['bg-size'].value) || 100;
      images.push({ url, bgX: parseFloat(controls['bg-x'].value) || 50, bgY: parseFloat(controls['bg-y'].value) || 50, bgSize, mode: controls['image-mode'].value || 'negative' });
      localStorage.setItem('bg-images', JSON.stringify(images));
      console.log('Images after adding:', images.length, 'bgSize:', bgSize);
      viewerImageIndex = images.length - 1;
      updateImageViewer();
      if (images.length === 1) {
        currentImageIndex = 0;
        preloadImage(images[0].url).then(success => {
          if (success) {
            applyImageSettings(0);
            previewBgLayer.style.backgroundImage = `url(${images[0].url})`;
          } else {
            bgLayer.style.background = '#1a1a1a';
            previewBgLayer.style.background = '#1a1a1a';
          }
        });
      }
      if (images.length > 1) {
        preloadAllImages().then(() => startSlideshow());
      }
      updateStyles();
    }
  });
}

function updateImageViewer() {
  console.log('Updating image viewer, index:', viewerImageIndex, 'images:', images.length);
  if (images.length === 0) {
    currentImage.src = '';
    currentImage.style.display = 'none';
    deleteImage.style.display = 'none';
    prevImage.disabled = true;
    nextImage.disabled = true;
    controls['bg-x'].disabled = true;
    controls['bg-y'].disabled = true;
    controls['bg-size'].disabled = true;
    controls['image-mode'].disabled = true;
  } else {
    currentImage.src = images[viewerImageIndex].url;
    currentImage.style.display = 'block';
    deleteImage.style.display = 'block';
    prevImage.disabled = viewerImageIndex === 0;
    nextImage.disabled = viewerImageIndex === images.length - 1;
    controls['bg-x'].disabled = false;
    controls['bg-y'].disabled = false;
    controls['bg-size'].disabled = false;
    controls['image-mode'].disabled = false;
    controls['bg-x'].value = images[viewerImageIndex].bgX || 50;
    controls['bg-y'].value = images[viewerImageIndex].bgY || 50;
    controls['bg-size'].value = images[viewerImageIndex].bgSize || 100;
    controls['image-mode'].value = images[viewerImageIndex].mode || 'negative';
    console.log('Image viewer updated, bgSize:', images[viewerImageIndex].bgSize);
  }
}

function applyImageSettings(index) {
  if (images[index]) {
    const { url, bgX = 50, bgY = 50, bgSize = 100, mode = 'negative' } = images[index];
    bgLayer.style.backgroundImage = `url(${url})`;
    bgLayer.style.backgroundPosition = `${bgX}% ${bgY}%`;
    bgLayer.style.backgroundSize = `${bgSize}% auto`;
    previewBgLayer.style.backgroundImage = `url(${url})`;
    previewBgLayer.style.backgroundPosition = `${bgX}% ${bgY}%`;
    previewBgLayer.style.backgroundSize = `${bgSize}% auto`;
    document.body.className = mode;
    bgLayer.classList.toggle('grayscale', mode === 'grayscale');
    previewBgLayer.classList.toggle('grayscale', mode === 'grayscale');
    bgLayer.offsetHeight; // Force reflow
    krakenPreview.offsetHeight; // Force reflow preview
    console.log('Applied settings for image', index, 'url:', url, 'position:', `${bgX}% ${bgY}%`, 'size:', `${bgSize}%`, 'mode:', mode);
  }
}

function startSlideshow() {
  stopSlideshow();
  if (images.length <= 1) {
    console.log('Slideshow not started: not enough images');
    return;
  }
  const duration = parseInt(controls['bg-duration'].value) * 1000;
  console.log('Starting slideshow, images:', images.length, 'duration:', duration);
  slideshowInterval = setInterval(() => {
    const nextIndex = (currentImageIndex + 1) % images.length;
    console.log('Slideshow tick, current:', currentImageIndex, 'next:', nextIndex);
    preloadImage(images[nextIndex].url).then(success => {
      if (!success) {
        console.warn('Skipping image due to preload failure');
        return;
      }
      currentImageIndex = nextIndex;
      const nextImage = images[nextIndex];
      applyImageSettings(nextIndex);
      console.log('Switched to image', nextIndex, 'url:', nextImage.url, 'position:', `${nextImage.bgX}% ${nextImage.bgY}%`, 'size:', `${nextImage.bgSize}%`, 'mode:', nextImage.mode);
    });
  }, duration);
}

function stopSlideshow() {
  if (slideshowInterval) {
    clearInterval(slideshowInterval);
    slideshowInterval = null;
    console.log('Slideshow stopped');
  }
}

prevImage.addEventListener('click', () => {
  if (viewerImageIndex > 0) {
    viewerImageIndex--;
    updateImageViewer();
    console.log('Navigated to previous image, index:', viewerImageIndex);
  }
});
nextImage.addEventListener('click', () => {
  if (viewerImageIndex < images.length - 1) {
    viewerImageIndex++;
    updateImageViewer();
    console.log('Navigated to next image, index:', viewerImageIndex);
  }
});
deleteImage.addEventListener('click', () => {
  if (images.length > 0) {
    console.log('Deleting image at index:', viewerImageIndex);
    images.splice(viewerImageIndex, 1);
    localStorage.setItem('bg-images', JSON.stringify(images));
    viewerImageIndex = Math.min(viewerImageIndex, images.length - 1);
    if (images.length > 0) {
      currentImageIndex = Math.min(currentImageIndex, images.length - 1);
      preloadImage(images[currentImageIndex].url).then(success => {
        if (success) {
          applyImageSettings(currentImageIndex);
          previewBgLayer.style.backgroundImage = `url(${images[currentImageIndex].url})`;
          if (images.length > 1) {
            preloadAllImages().then(() => startSlideshow());
          } else {
            stopSlideshow();
          }
        } else {
          bgLayer.style.background = '#1a1a1a';
          previewBgLayer.style.background = '#1a1a1a';
        }
      });
    } else {
      currentImageIndex = 0;
      bgLayer.style.backgroundImage = '';
      previewBgLayer.style.backgroundImage = '';
      stopSlideshow();
    }
    updateImageViewer();
    updateStyles();
  }
});

document.getElementById('reset-positions').addEventListener('click', () => {
  controls['clock-y'].value = '0';
  controls['monitoring-y'].value = '0';
  controls['global-scale'].value = '100';
  controls['global-spacing'].value = '100';
  if (images.length > 0) {
    images[viewerImageIndex].bgX = 50;
    images[viewerImageIndex].bgY = 50;
    images[viewerImageIndex].bgSize = 100;
    images[viewerImageIndex].mode = 'negative';
    controls['bg-x'].value = 50;
    controls['bg-y'].value = 50;
    controls['bg-size'].value = 100;
    controls['image-mode'].value = 'negative';
    localStorage.setItem('bg-images', JSON.stringify(images));
    updateImageViewer();
    if (viewerImageIndex === currentImageIndex) {
      preloadImage(images[currentImageIndex].url).then(success => {
        if (success) {
          applyImageSettings(currentImageIndex);
          previewBgLayer.style.backgroundImage = `url(${images[currentImageIndex].url})`;
        } else {
          bgLayer.style.background = '#1a1a1a';
          previewBgLayer.style.background = '#1a1a1a';
        }
      });
    }
  }
  updateStyles();
  console.log('Positions reset, clock-y:', controls['clock-y'].value, 'monitoring-y:', controls['monitoring-y'].value);
});

function updateClock() {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  document.getElementById('hours').textContent = hours;
  document.getElementById('minutes').textContent = minutes;
  document.getElementById('hours-preview').textContent = hours;
  document.getElementById('minutes-preview').textContent = minutes;
  clockContent.offsetHeight; // Force reflow
  clockContentPreview.offsetHeight; // Force reflow
  console.log('Clock updated, hours:', hours, 'minutes:', minutes, 'preview opacity:', getComputedStyle(clockContentPreview).opacity, 'clock-y:', controls['clock-y'].value);
}
setInterval(updateClock, 1000); updateClock();

let showClock = true;
function cycleContent() {
  if (showClock) {
    clockContent.classList.add('active');
    monitoringContent.classList.remove('active');
    clockContentPreview.classList.add('active');
    monitoringContentPreview.classList.remove('active');
  } else {
    monitoringContent.classList.add('active');
    clockContent.classList.remove('active');
    monitoringContentPreview.classList.add('active');
    clockContentPreview.classList.remove('active');
  }
  showClock = !showClock;
  clockContent.offsetHeight; // Force reflow
  clockContentPreview.offsetHeight; // Force reflow
  monitoringContent.offsetHeight; // Force reflow
  monitoringContentPreview.offsetHeight; // Force reflow
  console.log('Content cycled, showClock:', showClock, 'preview clock active:', clockContentPreview.classList.contains('active'), 'clock-y:', controls['clock-y'].value, 'monitoring-y:', controls['monitoring-y'].value);
}
setInterval(cycleContent, 10000);

function updateMonitoring(data) {
  try {
    const { cpus = [], gpus = [] } = data || {};
    const cpuTemp = cpus[0]?.temperature ? `${Math.round(cpus[0].temperature)}°` : '--°';
    const gpuTemp = gpus[0]?.temperature ? `${Math.round(gpus[0].temperature)}°` : '--°';
    document.getElementById('cpu-temp').textContent = cpuTemp;
    document.getElementById('gpu-temp').textContent = gpuTemp;
    document.getElementById('cpu-temp-preview').textContent = cpuTemp;
    document.getElementById('gpu-temp-preview').textContent = gpuTemp;
    console.log('Monitoring updated, cpuTemp:', cpuTemp, 'gpuTemp:', gpuTemp);
  } catch (e) { console.error('Monitoring error:', e); }
}

function simulateData() {
  if (!window.nzxt?.v1) {
    const cpuTemp = `${Math.round(40 + Math.random() * 40)}°`;
    const gpuTemp = `${Math.round(45 + Math.random() * 50)}°`;
    document.getElementById('cpu-temp').textContent = cpuTemp;
    document.getElementById('gpu-temp').textContent = cpuTemp;
    document.getElementById('cpu-temp-preview').textContent = cpuTemp;
    document.getElementById('gpu-temp-preview').textContent = gpuTemp;
  }
}
setInterval(simulateData, 3000);

window.nzxt = { v1: { onMonitoringDataUpdate: updateMonitoring, onError: e => console.warn('NZXT error:', e) } };

fileUpload.addEventListener('click', () => fileInput.click());
fileUpload.addEventListener('dragover', e => { e.preventDefault(); fileUpload.style.borderColor = '#4ecdc4'; });
fileUpload.addEventListener('dragleave', () => fileUpload.style.borderColor = 'rgba(255,255,255,0.3)');
fileUpload.addEventListener('drop', e => {
  e.preventDefault(); fileUpload.style.borderColor = 'rgba(255,255,255,0.3)';
  if (e.dataTransfer.files.length) addImage(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => {
  if (e.target.files.length) addImage(e.target.files[0]);
});

function updateStyles() {
  const globalScale = parseFloat(controls['global-scale'].value) / 100;
  const globalSpacing = parseFloat(controls['global-spacing'].value) / 100;
  const styleProps = {
    '--hours-size': `${controls['hours-size'].value}px`,
    '--minutes-size': `${controls['minutes-size'].value}px`,
    '--hours-weight': controls['hours-weight'].value,
    '--minutes-weight': controls['minutes-weight'].value,
    '--hours-spacing': `${parseFloat(controls['hours-spacing'].value) * globalSpacing}px`,
    '--clock-y': `${parseFloat(controls['clock-y'].value) * globalSpacing}%`,
    '--temp-size': `${controls['temp-size'].value}px`,
    '--label-size': `${controls['label-size'].value}px`,
    '--temp-weight': controls['temp-weight'].value,
    '--label-weight': controls['temp-weight'].value,
    '--temp-spacing': `${parseFloat(controls['temp-spacing'].value) * globalSpacing}px`,
    '--temp-gap': `${parseFloat(controls['temp-gap'].value) * globalSpacing}px`,
    '--label-opacity': controls['label-opacity'].value,
    '--glow-intensity': `${controls['glow-intensity'].value}px`,
    '--text-stroke': `${controls['text-stroke'].value}px`,
    '--monitoring-y': `${parseFloat(controls['monitoring-y'].value) * globalSpacing}%`,
    '--global-scale': globalScale,
    '--brightness': controls['brightness'].value,
    '--contrast': controls['contrast'].value,
    '--saturation': controls['saturation'].value,
    '--primary-color': controls['primary-color'].value,
    '--secondary-color': controls['secondary-color'].value,
    '--accent-color': controls['accent-color'].value,
    '--gradient-angle': `${controls['gradient-angle'].value}deg`,
    '--gradient-speed': `${controls['gradient-speed'].value}s`,
    '--gradient-size': `${controls['gradient-size'].value}%`,
    '--gradient-brightness': controls['gradient-brightness'].value,
    '--grayscale-brightness': controls['grayscale-brightness'].value,
    '--grayscale-contrast': controls['grayscale-contrast'].value
  };
  Object.entries(styleProps).forEach(([key, value]) => document.documentElement.style.setProperty(key, value));
  bgDurationValue.textContent = `${controls['bg-duration'].value} s`;

  if (images.length > 0 && images[viewerImageIndex]) {
    const bgSize = parseFloat(controls['bg-size'].value) || 100;
    images[viewerImageIndex].bgX = parseFloat(controls['bg-x'].value) || 50;
    images[viewerImageIndex].bgY = parseFloat(controls['bg-y'].value) || 50;
    images[viewerImageIndex].bgSize = bgSize;
    images[viewerImageIndex].mode = controls['image-mode'].value || 'negative';
    localStorage.setItem('bg-images', JSON.stringify(images));
    console.log('Updated image settings, index:', viewerImageIndex, 'bgSize:', bgSize, 'hours-size:', controls['hours-size'].value, 'minutes-size:', controls['minutes-size'].value);
    if (viewerImageIndex === currentImageIndex) {
      preloadImage(images[currentImageIndex].url).then(success => {
        if (success) {
          applyImageSettings(currentImageIndex);
          previewBgLayer.style.backgroundImage = `url(${images[currentImageIndex].url})`;
        } else {
          bgLayer.style.background = '#1a1a1a';
          previewBgLayer.style.background = '#1a1a1a';
        }
      });
    }
  }

  const url = controls['bg-url'].value.trim();
  if (url && images.length === 0) {
    preloadImage(url).then(success => {
      if (success) {
        const bgSize = parseFloat(controls['bg-size'].value) || 100;
        images = [{ url, bgX: 50, bgY: 50, bgSize, mode: 'negative' }];
        currentImageIndex = 0;
        viewerImageIndex = 0;
        applyImageSettings(0);
        previewBgLayer.style.backgroundImage = `url(${url})`;
        localStorage.setItem('bg-images', JSON.stringify(images));
        updateImageViewer();
        stopSlideshow();
        console.log('Loaded URL image:', url, 'bgSize:', bgSize);
      } else {
        bgLayer.style.background = '#1a1a1a';
        previewBgLayer.style.background = '#1a1a1a';
        console.error('Failed to load URL image:', url);
      }
    });
  }

  Object.keys(controls).forEach(key => localStorage.setItem(key, controls[key].value));
  clockContent.offsetHeight; // Force reflow
  krakenPreview.offsetHeight; // Force reflow
  console.log('Styles updated, hours-size:', getComputedStyle(document.documentElement).getPropertyValue('--hours-size'), 'minutes-size:', getComputedStyle(document.documentElement).getPropertyValue('--minutes-size'), 'global-scale:', styleProps['--global-scale'], 'global-spacing:', globalSpacing, 'preview clock opacity:', getComputedStyle(clockContentPreview).opacity, 'clock-y:', controls['clock-y'].value, 'monitoring-y:', controls['monitoring-y'].value, 'text-stroke:', controls['text-stroke'].value);
}

let isDraggingBg = false, isDraggingClock = false, isDraggingMonitoring = false, startX, startY, dragSpeed = 1;
bgContainer.addEventListener('mousedown', e => {
  isDraggingBg = true; startX = e.clientX; startY = e.clientY;
  dragSpeed = 1; // Reset vitesse
  console.log('Background drag started');
});
clockContent.addEventListener('mousedown', e => {
  if (clockContent.classList.contains('active')) {
    isDraggingClock = true; startX = e.clientX; startY = e.clientY;
    dragSpeed = 1;
    console.log('Clock drag started, clock-y:', controls['clock-y'].value);
  }
});
monitoringContent.addEventListener('mousedown', e => {
  if (monitoringContent.classList.contains('active')) {
    isDraggingMonitoring = true; startX = e.clientX; startY = e.clientY;
    dragSpeed = 1;
    console.log('Monitoring drag started, monitoring-y:', controls['monitoring-y'].value);
  }
});
document.addEventListener('mousemove', e => {
  if (isDraggingBg && images.length > 0) {
    const dx = (e.clientX - startX) / window.innerWidth * 100 * dragSpeed;
    const dy = (e.clientY - startY) / window.innerHeight * 100 * dragSpeed;
    images[currentImageIndex].bgX = Math.max(0, Math.min(100, (images[currentImageIndex].bgX || 50) + dx));
    images[currentImageIndex].bgY = Math.max(0, Math.min(100, (images[currentImageIndex].bgY || 50) + dy));
    controls['bg-x'].value = images[currentImageIndex].bgX;
    controls['bg-y'].value = images[currentImageIndex].bgY;
    applyImageSettings(currentImageIndex);
    if (viewerImageIndex === currentImageIndex) updateImageViewer();
    localStorage.setItem('bg-images', JSON.stringify(images));
    startX = e.clientX; startY = e.clientY;
    dragSpeed = Math.min(dragSpeed + 0.02, 3); // Accélère progressivement
    console.log('Background dragged, bgX:', images[currentImageIndex].bgX, 'bgY:', images[currentImageIndex].bgY);
  }
  if (isDraggingClock && clockContent.classList.contains('active')) {
    const dy = (e.clientY - startY) / window.innerHeight * 100 * dragSpeed;
    const currentY = parseFloat(controls['clock-y'].value) || 0;
    controls['clock-y'].value = Math.max(-50, Math.min(50, currentY + dy));
    updateStyles();
    startX = e.clientX; startY = e.clientY;
    dragSpeed = Math.min(dragSpeed + 0.02, 3);
    console.log('Clock dragged, clock-y:', controls['clock-y'].value);
  }
  if (isDraggingMonitoring && monitoringContent.classList.contains('active')) {
    const dy = (e.clientY - startY) / window.innerHeight * 100 * dragSpeed;
    const currentY = parseFloat(controls['monitoring-y'].value) || 0;
    controls['monitoring-y'].value = Math.max(-50, Math.min(50, currentY + dy));
    updateStyles();
    startX = e.clientX; startY = e.clientY;
    dragSpeed = Math.min(dragSpeed + 0.02, 3);
    console.log('Monitoring dragged, monitoring-y:', controls['monitoring-y'].value);
  }
});
document.addEventListener('mouseup', () => {
  isDraggingBg = false;
  isDraggingClock = false;
  isDraggingMonitoring = false;
  dragSpeed = 1;
  console.log('Drag ended');
});

Object.values(controls).forEach(control => {
  control.addEventListener('input', () => {
    updateStyles();
    if (control.id === 'bg-duration' && images.length > 1) {
      console.log('Duration changed:', controls['bg-duration'].value);
      preloadAllImages().then(() => startSlideshow());
    }
  });
});

togglePanel.addEventListener('click', () => {
  const isVisible = controlsPanel.style.display === 'flex';
  controlsPanel.style.display = isVisible ? 'none' : 'flex';
  togglePanel.textContent = isVisible ? '⚙️' : '✕';
  krakenPreview.classList.toggle('active', !isVisible);
  console.log('Toggle panel clicked, controls display:', controlsPanel.style.display, 'preview active:', krakenPreview.classList.contains('active'), 'toggle text:', togglePanel.textContent);
});

function loadSettings() {
  Object.keys(controls).forEach(key => {
    const saved = localStorage.getItem(key);
    if (saved !== null) controls[key].value = saved;
  });
  const savedImages = localStorage.getItem('bg-images');
  if (savedImages) {
    try {
      images = JSON.parse(savedImages);
      images = images.map(img => ({
        url: img.url,
        bgX: parseFloat(img.bgX) || 50,
        bgY: parseFloat(img.bgY) || 50,
        bgSize: parseFloat(img.bgSize) || 100,
        mode: img.mode || 'negative'
      }));
      console.log('Loaded images from localStorage:', images.length, 'first image bgSize:', images[0]?.bgSize);
      if (images.length > 0) {
        currentImageIndex = 0;
        viewerImageIndex = 0;
        preloadAllImages().then(() => {
          applyImageSettings(0);
          previewBgLayer.style.backgroundImage = `url(${images[0].url})`;
          updateImageViewer();
          if (images.length > 1) startSlideshow();
        });
      }
    } catch (e) {
      console.error('Error parsing bg-images from localStorage:', e);
    }
  }
  updateStyles();
  controlsPanel.style.display = 'none';
  togglePanel.style.display = 'block';
  togglePanel.style.opacity = '1';
  krakenPreview.classList.add('active');
  clockContent.classList.add('active');
  clockContentPreview.classList.add('active');
  console.log('Settings loaded, preview active:', krakenPreview.classList.contains('active'), 'clock preview opacity:', getComputedStyle(clockContentPreview).opacity, 'toggle display:', togglePanel.style.display, 'toggle opacity:', togglePanel.style.opacity, 'clock-y:', controls['clock-y'].value, 'monitoring-y:', controls['monitoring-y'].value, 'text-stroke:', controls['text-stroke'].value);
}

loadSettings();
</script>
</body>
</html>
